name: ðŸš€ Webpack Build & Quality Audit

on:
  push:
    branches: ['dev']
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

concurrency:
  group: 'site-deploy'
  cancel-in-progress: true

jobs:
  build:
    name: ðŸ›  Build Project
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '22.x'
          cache: 'npm'

      - run: npm ci
      - run: npm run build

      - uses: actions/upload-artifact@v4
        with:
          name: build
          path: dist
          retention-days: 1

  bundle_size:
    name: ðŸ“¦ Bundle Size Audit
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: build
          path: dist

      - uses: actions/setup-node@v4
        with:
          node-version: '22.x'

      - run: npm install -g bundle-size-analyzer
      - run: bundle-size-analyzer dist

  audit:
    name: ðŸ”’ Security Audit
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '22.x'
          cache: 'npm'

      - run: npm ci
      - run: npm audit --audit-level=high

  lighthouse:
    name: ðŸ’¡ Lighthouse Audit
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: build
          path: dist

      - uses: actions/setup-node@v4
        with:
          node-version: '22.x'

      - run: npm install -g @lhci/cli@0.13.x http-server wait-on
      - run: |
          http-server dist -p 8080 &
          npx wait-on http://localhost:8080
          lhci autorun --url=http://localhost:8080 --outputDir=lhci-report

      - uses: actions/upload-artifact@v4
        with:
          name: lighthouse-report
          path: lhci-report

  accessibility:
    name: â™¿ Accessibility Audit
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: build
          path: dist

      - uses: actions/setup-node@v4
        with:
          node-version: '22.x'

      - run: npm install -g axe-cli http-server wait-on
      - run: |
          http-server dist -p 8081 &
          npx wait-on http://localhost:8081
          axe http://localhost:8081 --exit > axe-results/report.txt

      - uses: actions/upload-artifact@v4
        with:
          name: axe-report
          path: axe-results

  deploy:
    name: ðŸš¢ Deploy to GitHub Pages
    runs-on: ubuntu-latest
    needs: [build, bundle_size, audit, lighthouse, accessibility]
    steps:
      - uses: actions/checkout@v4

      - uses: actions/download-artifact@v4
        with:
          name: build
          path: dist

      - uses: JamesIves/github-pages-deploy-action@v4
        with:
          branch: build
          folder: dist
          clean: true
          message: 'Deploy from ${{ github.sha }}'
